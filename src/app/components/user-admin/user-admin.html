<div class="admin-container">
  <!-- Header -->
  <div class="admin-header" tabindex="0">
    <h1 tabindex="0">👥 Administración de Usuarios</h1>
    <p tabindex="0">Gestión de usuarios del sistema</p>
    <h2 tabindex="0">Bienvenido Administrador, {{ authService.currentUserNombreCompleto || 'Cargando' }}</h2>
  </div>

  <!-- Loading -->
  @if (loading) {
  <div class="loading-state" tabindex="0" aria-label="Cargando usuarios">
    <div class="spinner" aria-hidden="true"></div>
    <p tabindex="0">Cargando usuarios...</p>
  </div>
  }

  <!-- Tabla de usuarios -->
  @if (!loading && users.length > 0) {
  <div class="table-container">
    <div class="table-responsive">
      <table class="users-table" aria-label="Lista de usuarios del sistema">
        <thead>
          <tr>
            <th scope="col" tabindex="0">Nombre Completo</th>
            <th scope="col" tabindex="0">Email</th>
            <th scope="col" tabindex="0">Universidad</th>
            <th scope="col" tabindex="0">Ciudad</th>
            <th scope="col" tabindex="0">Carrera</th>
            <th scope="col" tabindex="0">Rol</th>
            <th scope="col" tabindex="0">Fecha Registro</th>
            <th scope="col" tabindex="0">Modificado Por</th>
            <th scope="col" tabindex="0">Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users; track user.uid) {
          <tr>
            <td>
              <div class="user-info">
                <div class="user-avatar" tabindex="0" aria-label="Inicial del nombre">
                  {{ getNombreCompleto(user).charAt(0) }}
                </div>
                <div class="user-details">
                  <div class="user-name" tabindex="0">{{ getNombreCompleto(user) }}</div>
                </div>
              </div>
            </td>
            <td tabindex="0">{{ user.email }}</td>
            <td>
              <span class="badge university" tabindex="0">{{ user.universidad }}</span>
            </td>
            <td tabindex="0">{{ user.ciudad }}</td>
            <td tabindex="0">{{ user.carrera }}</td>
            <td>
              <span class="badge role-{{ user.rol?.toLowerCase() }}" tabindex="0">
                {{ user.rol }}
              </span>
            </td>
            <td tabindex="0">{{ formatearFecha(user.createdAt) }}</td>
            <td>
              @if (user.modificadoPor) {
              <div class="modificado-info" tabindex="0">
                <div class="modificado-nombre" tabindex="0">{{ user.modificadoPor.nombre }}</div>
                <div class="modificado-fecha" tabindex="0">{{ formatearFecha(user.modificadoPor.fecha) }}</div>
                <div class="modificado-uuid" tabindex="0">UUID: {{ user.modificadoPor.uuid }}</div>
              </div>
              } @else {
              <span class="no-modificado" tabindex="0">Nunca modificado</span>
              }
            </td>
            <td>
              <button 
                class="edit-btn"
                (click)="editarUsuario(user)"
                tabindex="0"
                attr.aria-label="Editar usuario {{ getNombreCompleto(user) }}"
              >
                ✏️ Editar
              </button>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
  }

  <!-- Sin usuarios -->
  @if (!loading && users.length === 0) {
  <div class="no-data" tabindex="0">
    <p tabindex="0">No hay usuarios registrados</p>
  </div>
  }
  
  <br>
  <br>
  
  <button routerLink="/registrar" 
       class="btn btn-secondary"
        style="padding: 10px 20px"
        tabindex="0"
        aria-label="Añadir nuevo usuario">
    Añadir Usuario
  </button>

  <!-- Modal de edición -->
  @if (editingUser) {
  <div class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title" tabindex="0">✏️ Editar Usuario</h2>
        <button class="close-btn" (click)="cancelarEdicion()" tabindex="0" aria-label="Cerrar modal de edición">
          ×
        </button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="guardarCambios()" #userForm="ngForm" role="form">
          
          <!-- Información Básica -->
          <div class="form-section" tabindex="0">
            <h3 class="section-title" tabindex="0">
              <span class="section-icon" aria-hidden="true">👤</span>
              Información Personal
            </h3>
            <div class="form-grid">
              
              <div class="form-group">
                <label for="primerNombre" tabindex="0">Primer Nombre *</label>
                <input 
                  type="text" 
                  id="primerNombre"
                  [(ngModel)]="editedUser.primerNombre" 
                  name="primerNombre"
                  required
                  placeholder="Ingrese el primer nombre"
                  tabindex="0"
                  aria-required="true"
                >
              </div>

              <div class="form-group">
                <label for="segundoNombre" tabindex="0">Segundo Nombre</label>
                <input 
                  type="text" 
                  id="segundoNombre"
                  [(ngModel)]="editedUser.segundoNombre" 
                  name="segundoNombre"
                  placeholder="Opcional"
                  tabindex="0"
                >
              </div>

              <div class="form-group">
                <label for="primerApellido" tabindex="0">Primer Apellido *</label>
                <input 
                  type="text" 
                  id="primerApellido"
                  [(ngModel)]="editedUser.primerApellido" 
                  name="primerApellido"
                  required
                  placeholder="Ingrese el primer apellido"
                  tabindex="0"
                  aria-required="true"
                >
              </div>

              <div class="form-group">
                <label for="segundoApellido" tabindex="0">Segundo Apellido</label>
                <input 
                  type="text" 
                  id="segundoApellido"
                  [(ngModel)]="editedUser.segundoApellido" 
                  name="segundoApellido"
                  placeholder="Opcional"
                  tabindex="0"
                >
              </div>

            </div>
          </div>

          <!-- Información Académica -->
          <div class="form-section" tabindex="0">
            <h3 class="section-title" tabindex="0">
              <span class="section-icon" aria-hidden="true">🎓</span>
              Información Académica
            </h3>
            <div class="form-grid">
              
              <div class="form-group">
                <label for="universidad" tabindex="0">Universidad *</label>
                <select 
                  id="universidad"
                  [(ngModel)]="editedUser.universidad" 
                  name="universidad"
                  required
                  tabindex="0"
                  aria-required="true"
                >
                  <option value="">Seleccionar universidad</option>
                  @for (uni of universidades; track uni) {
                  <option [value]="uni">{{ uni }}</option>
                  }
                </select>
              </div>

              <div class="form-group">
                <label for="ciudad" tabindex="0">Ciudad *</label>
                <select 
                  id="ciudad"
                  [(ngModel)]="editedUser.ciudad" 
                  name="ciudad"
                  required
                  tabindex="0"
                  aria-required="true"
                >
                  <option value="">Seleccionar ciudad</option>
                  @for (ciudad of ciudades; track ciudad) {
                  <option [value]="ciudad">{{ ciudad }}</option>
                  }
                </select>
              </div>

              <div class="form-group">
                <label for="carrera" tabindex="0">Carrera *</label>
                <input 
                  type="text" 
                  id="carrera"
                  [(ngModel)]="editedUser.carrera" 
                  name="carrera"
                  required
                  placeholder="Ingrese la carrera"
                  tabindex="0"
                  aria-required="true"
                >
              </div>

              <div class="form-group">
                <label for="rol" tabindex="0">Rol *</label>
                <select 
                  id="rol"
                  [(ngModel)]="editedUser.rol" 
                  name="rol"
                  required
                  tabindex="0"
                  aria-required="true"
                >
                  <option value="">Seleccionar rol</option>
                  @for (rol of roles; track rol) {
                  <option [value]="rol">{{ rol }}</option>
                  }
                </select>
              </div>

            </div>
          </div>

          <!-- Información de Contacto -->
          <div class="form-section" tabindex="0">
            <h3 class="section-title" tabindex="0">
              <span class="section-icon" aria-hidden="true">📧</span>
              Información de Contacto
            </h3>
            <div class="form-grid">
              
              <div class="form-group full-width">
                <label for="email" tabindex="0">Correo Electrónico</label>
                <input 
                  type="email" 
                  id="email"
                  [value]="editedUser.email" 
                  disabled
                  class="disabled-field"
                  placeholder="Email del usuario"
                  tabindex="0"
                  aria-disabled="true"
                >
                <small class="field-note" tabindex="0">El email no se puede modificar</small>
              </div>

            </div>
          </div>

          <!-- Acciones -->
          <div class="modal-actions">
            <button 
              type="button" 
              class="cancel-btn"
              (click)="cancelarEdicion()"
              tabindex="0"
              aria-label="Cancelar edición"
            >
              Cancelar
            </button>
            <button 
              type="submit" 
              class="save-btn"
              [disabled]="!userForm.valid"
              tabindex="0"
              aria-label="Guardar cambios del usuario"
            >
              💾 Guardar Cambios
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>
  }
</div>